# AI对话流软件使用说明

## 功能概述

这是一个面向后端 API 的对话应用，默认通过 `OkHttp` 连接本机后端（Spring Boot）并以 `SSE` 文本流方式接收增量回复；当网络不可用或请求失败时，使用内置规则引擎进行兜底回复。

## 主要特性

- ✅ **SSE流式回复**：与后端建立 `text/event-stream` 连接，消息实时追加
- ✅ **兜底规则引擎**：网络失败自动降级到本地规则回复
- ✅ **持久化历史**：使用 Room 保存消息记录并恢复会话
- ✅ **现代化UI**：Material Design 3 + Compose
- ✅ **真机一键联调**：支持 USB 反向映射或同一子网直连

## 如何自定义对话规则

### 修改对话规则

编辑文件：`app/src/main/java/com/example/aichat_10/service/ChatRuleEngine.kt`

在 `rules` 映射表中添加或修改规则：

```kotlin
private val rules = mapOf(
    // 添加新规则
    listOf("关键词1", "关键词2", "关键词3") to "对应的回复内容",
    
    // 示例：添加天气规则
    listOf("天气", "今天天气", "明天天气") to "抱歉，我目前无法获取实时天气信息。",
    
    // 示例：添加问候规则
    listOf("你好", "您好", "hello") to "你好！很高兴和你聊天！",
)
```

### 规则格式说明

- **关键词列表**：用户输入中包含这些关键词中的任意一个，就会触发该规则
- **回复内容**：匹配到规则后，AI会返回这个回复
- **匹配顺序**：按照规则定义的顺序进行匹配，找到第一个匹配的规则就返回

### 添加智能回复

如果没有匹配到任何规则，系统会调用 `generateSmartResponse()` 方法生成默认回复。你可以修改这个方法来改变默认回复的逻辑。

## 对话规则示例

当前已包含的规则：

1. **问候语**：你好、您好、hello、hi等
2. **自我介绍**：你是谁、介绍自己等
3. **功能询问**：你能做什么、功能等
4. **感谢**：谢谢、感谢等
5. **再见**：再见、拜拜等
6. **询问状态**：你好吗、怎么样等

## 使用建议

### 添加新规则的最佳实践

1. **关键词选择**：
   - 选择用户可能使用的常见表达
   - 考虑同义词和变体（如"你好"和"您好"）
   - 避免过于宽泛的关键词

2. **回复内容**：
   - 保持友好和专业的语气
   - 回复要简洁明了
   - 可以包含多行文本（使用 `\n` 换行）

3. **规则顺序**：
   - 将更具体的规则放在前面
   - 将通用规则放在后面
   - 默认回复放在最后

### 示例：添加产品咨询规则

```kotlin
listOf("产品", "价格", "多少钱", "费用") to 
    "关于产品信息，你可以：\n" +
    "• 查看我们的官方网站\n" +
    "• 联系客服热线：400-xxx-xxxx\n" +
    "• 发送邮件至：support@example.com"
```

## 技术架构

- **UI层**：Jetpack Compose + Material Design 3
- **状态管理**：ViewModel + StateFlow（增量拼接 SSE 消息）
- **网络层**：OkHttp（SSE 流式响应，Header `Accept: text/event-stream`）
- **对话兜底**：基于关键词匹配的规则引擎
- **持久化**：Room（消息入库与增量更新）
- **异步处理**：Kotlin Coroutines

## 运行与联调

- 后端启动
  - 在电脑上启动 Spring Boot 后端（监听 `8080`，建议 `0.0.0.0`）。
  - 若端口被占用，先释放后再启动（见下文“构建稳定性与故障排查”）。

- Android Studio 真机运行（推荐：USB 反向映射）
  - 在 Run 配置的 “Before launch” 添加外部工具：`adb reverse tcp:8080 tcp:8080`。
  - 点击 Run，IDE 将自动完成端口映射并安装最新 APK 到真机。
  - App 访问地址固定为 `http://127.0.0.1:8080`（`app/src/main/java/com/example/aichat_10/viewmodel/ChatViewModel.kt:32`）。

- 同一子网直连（可选）
  - 将 `serverBase` 修改为 `http://<电脑局域网IP>:8080`。
  - 确保电脑防火墙放行 8080 端口，后端监听 `0.0.0.0`。
  - 适用于无线联调或无法使用 USB 的场景。

## 项目结构

```
app/src/main/java/com/example/aichat_10/
├── data/
│   └── Message.kt              # 消息数据模型
├── service/
│   └── ChatRuleEngine.kt        # 对话规则引擎（可自定义）
├── viewmodel/
│   └── ChatViewModel.kt         # 状态管理
├── ui/
│   └── components/
│       └── ChatScreen.kt        # 对话界面
└── MainActivity.kt               # 主Activity
```

## 常见问题

### Q: 如何添加多轮对话？
A: 可以在 `ChatRuleEngine` 中添加对话状态管理，根据上下文来生成不同的回复。

### Q: 如何支持更复杂的对话逻辑？
A: 可以扩展 `ChatRuleEngine`，添加对话流程管理、上下文记忆等功能。

### Q: 能否集成真实的AI API？
A: 可以，只需要在 `ChatViewModel` 的网络请求部分替换为你的 API 调用，同时保留规则引擎作为失败兜底即可。

### Q: 真机如何连通后端？
A: 推荐 USB 反向映射：在 Run 的 “Before launch” 添加 `adb reverse tcp:8080 tcp:8080`，App 侧使用 `http://127.0.0.1:8080`。若同一子网直连，请改为电脑 IP 并放行防火墙。

## 构建稳定性与故障排查

- `R.jar` 文件锁导致 `:app:processDebugResources FAILED`
  - 关闭 Desktop Preview、App Inspection、Layout Validation、Profiler、Running Devices、Logcat 等常驻窗口。
  - 在 IDE 中将 `app/build` 标记为 `Excluded`，必要时 `File -> Invalidate Caches...`。
  - 已在 `app/build.gradle.kts:80-84` 添加预清理中间目录；`gradle.properties:10` 设置单 worker；`gradle.properties:25` 禁用 KAPT worker API。
  - 命令行构建更稳定：`./gradlew :app:cleanBuildDebug -x lint`；构建前可 `./gradlew --stop`。

- 后端 8080 端口占用
  - 在后端 IDE 启动前执行释放命令，或调整为启动组的前置动作；确保端口可用后启动。

## 下一步扩展

- [ ] 支持对话历史记录
- [ ] 添加多轮对话上下文
- [ ] 支持文件导入对话规则
- [ ] 添加对话统计和分析
- [ ] 支持语音输入输出

---

**版本**: 1.0  
**更新日期**: 2025年11月

