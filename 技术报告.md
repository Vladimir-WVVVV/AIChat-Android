# AI 对话应用技术报告

## 项目概述

Android AI 对话应用（AIChat-10），采用 MVVM + Compose + Room，网络层使用 OkHttp 直连自研后端（Spring Boot），通过 SSE 文本流接收增量响应；认证改为账号密码登录/注册，支持短期免登录。

**平台**: Android  
**最低版本**: Android 11 (API 30)  
**目标版本**: Android 14 (API 36)  
**语言**: Kotlin

---

## 更新摘要（2025-12-05）
- 认证方式：删除短信验证码，改为账号密码登录/注册；支持令牌 TTL 或过期时间，短期免登录。
- 联调能力：登录页支持保存后端地址与“测试连接”（/health、/actuator/health、/auth/login 回退）。
- 模型与多模态：支持模型切换与图片上传，图片消息缩略图显示；并发与错误提示优化（429/forbidden）。
- 后端连通：真机可用 `adb reverse`（127.0.0.1:8080）或局域网直连（电脑 IP:8080）；模拟器用 10.0.2.2:8080。
- 构建目录：`app/buildDir = build2`，并在 `.gitignore` 忽略 `/app/build2`，减少锁文件影响。

---

## 架构与模块

- UI：Jetpack Compose + Material Design 3
- 状态：ViewModel + StateFlow（SSE 增量拼接）
- 网络：OkHttp（`Accept: text/event-stream`）+ 全局认证拦截器
- 数据：Room（消息持久化与分页）
- 认证：账号密码登录/注册 + 本地令牌与过期时间管理

---

## 关键实现要点

- 认证与免登录
  - 登录/注册返回 `token` 与 `ttlSec` 或 `expiresAt`，前端保存并在未过期时免登录。
- 联接自检
  - 依次检测 `/health`、`/actuator/health`，最终尝试 `/auth/login`（任何 2xx–4xx 视为网络可达）。
- 模型与多模态
  - 图片上传前校验 MIME 与大小，失败时在消息流内友好提示；服务端限流返回 429 时前端提示并终止流。
- 构建与发布
  - 调整构建目录为 `build2` 防止 R.jar 锁冲突；推送到 GitHub 时忽略构建产物。

---

## 运行环境与地址选择

- 真机 + USB：`adb reverse tcp:8080 tcp:8080`，App 地址 `http://127.0.0.1:8080`
- 模拟器：App 地址 `http://10.0.2.2:8080`
- 局域网：App 地址 `http://<电脑IP>:8080`（后端监听 `0.0.0.0`，防火墙放行 8080）

---

## 后续计划

- 统一错误码展示与重试策略
- 更细粒度的并发控制与排队提示
- 组件化的模型管理与配置下发

---

**版本**: 1.1  
**更新日期**: 2025-12-05
data class ChatRequest(
    val model: String,
    val messages: List<ChatMessage>
)

data class ChatResponse(
    val choices: List<Choice>
)
```

---

## 关键技术实现

### 1. 状态管理实现

#### 1.1 消息列表管理
- 使用`StateFlow<List<Message>>`管理对话消息
- 支持实时添加新消息
- UI自动响应数据变化

#### 1.2 加载状态管理
- `isLoading: StateFlow<Boolean>`跟踪网络请求状态
- 防止重复请求
- 提供加载指示器状态

#### 1.3 错误处理
- `error: StateFlow<String?>`管理错误信息
- 统一的错误处理机制
- 用户友好的错误提示

### 2. 网络请求流程

```
用户发送消息
    ↓
ViewModel.sendMessage()
    ↓
创建用户消息对象 → 添加到消息列表
    ↓
启动协程 (viewModelScope.launch)
    ↓
转换消息格式 (Message → ChatMessage)
    ↓
调用 Retrofit 接口
    ↓
OkHttp 发送 HTTP 请求
    ↓
OpenAI API 处理请求
    ↓
接收响应
    ↓
Gson 反序列化 JSON
    ↓
更新 StateFlow
    ↓
UI 自动刷新
```

### 3. 错误处理机制

- **网络错误**: 捕获异常并显示友好提示
- **API错误**: 处理HTTP错误码
- **数据错误**: 处理空响应或格式错误
- **超时处理**: OkHttp超时配置

---

## 项目结构

```
app/src/main/java/com/example/aichat_10/
├── data/                          # 数据模型层
│   ├── Message.kt                # 消息数据模型
│   └── ChatRequest.kt             # API请求/响应模型
├── service/                       # 服务层
│   ├── AIService.kt              # Retrofit接口定义
│   └── ApiClient.kt              # 网络客户端配置
├── viewmodel/                     # ViewModel层
│   └── ChatViewModel.kt          # 对话状态管理
├── ui/                           # UI层
│   ├── components/               # UI组件
│   │   └── ChatScreen.kt         # 主对话界面
│   └── theme/                    # 主题配置
│       ├── Color.kt
│       ├── Theme.kt
│       └── Type.kt
└── MainActivity.kt                # 主Activity
```

---

## 依赖管理

### 核心依赖列表

| 依赖库 | 版本 | 用途 |
|--------|------|------|
| androidx.compose.bom | 2024.09.00 | Compose版本管理 |
| androidx.compose.material3 | - | Material3组件 |
| androidx.lifecycle-viewmodel-compose | 2.8.6 | ViewModel支持 |
| retrofit2:retrofit | 2.11.0 | 网络请求库 |
| retrofit2:converter-gson | 2.11.0 | JSON转换器 |
| okhttp3:okhttp | 4.12.0 | HTTP客户端 |
| com.google.code.gson:gson | 2.11.0 | JSON序列化 |
| kotlinx-coroutines-android | 1.9.0 | 协程支持 |

### 版本管理

项目使用 **Version Catalog** (`libs.versions.toml`) 统一管理依赖版本，提高可维护性。

---

## 性能优化

### 1. 异步处理
- 所有网络请求在后台线程执行
- 使用协程避免阻塞主线程
- ViewModel自动管理协程生命周期

### 2. 状态更新
- StateFlow仅在数据变化时通知观察者
- Compose智能重组，只更新变化的部分

### 3. 网络优化
- 连接池复用
- 请求超时配置
- 日志拦截器（仅开发环境）

---

## 安全性考虑

### 1. API密钥管理
- **当前实现**: 硬编码在ViewModel中（仅用于开发）
- **生产环境建议**:
  - 使用Android Keystore存储
  - 从服务器获取临时token
  - 使用环境变量或配置文件（不提交到版本控制）

### 2. 网络安全
- HTTPS通信
- 证书验证
- 请求头安全配置

### 3. 数据隐私
- 本地不持久化敏感对话内容（当前实现）
- 可扩展：支持本地加密存储

---

## 扩展性设计

### 1. 多AI服务支持
- 接口抽象，易于切换不同的AI服务提供商
- 统一的请求/响应模型

### 2. 消息持久化
- 可扩展Room数据库支持
- 支持对话历史记录

### 3. 功能扩展
- 支持流式响应（Streaming）
- 支持多轮对话上下文管理
- 支持文件上传和图片识别

---

## 开发工具链

### 构建工具
- **Gradle**: 8.13.1
- **Kotlin**: 2.0.21
- **AGP**: 8.13.1

### 开发环境
- **IDE**: Android Studio
- **最低SDK**: 30 (Android 11)
- **目标SDK**: 36 (Android 14)

---

## 测试策略

### 单元测试
- ViewModel逻辑测试
- 数据模型测试
- 服务层Mock测试

### UI测试
- Compose UI测试
- 集成测试

### 测试依赖
- JUnit 4.13.2
- androidx.test.ext:junit 1.3.0
- androidx.compose.ui:ui-test-junit4

---

## 已知限制与改进方向

### 当前限制
1. API密钥硬编码（需改进为安全存储）
2. 不支持流式响应（需添加Streaming支持）
3. 无本地数据持久化
4. 错误处理可进一步优化

### 改进方向
1. **安全性增强**
   - 实现安全的密钥存储
   - 添加请求加密

2. **功能增强**
   - 支持流式响应显示
   - 添加对话历史记录
   - 支持多会话管理

3. **用户体验**
   - 添加消息发送动画
   - 支持Markdown渲染
   - 添加代码高亮显示

4. **性能优化**
   - 实现消息分页加载
   - 添加图片缓存
   - 优化大文本渲染

---

## 总结

本项目采用现代化的Android开发技术栈，实现了完整的AI对话功能。通过MVVM架构、响应式编程和协程异步处理，构建了一个高性能、可维护的Android应用。技术选型兼顾了开发效率、代码质量和用户体验，为后续功能扩展奠定了良好基础。

---

## 附录

### A. 关键代码位置

| 功能 | 文件路径 |
|------|----------|
| 状态管理 | `app/src/main/java/com/example/aichat_10/viewmodel/ChatViewModel.kt` |
| 网络服务 | `app/src/main/java/com/example/aichat_10/service/AIService.kt` |
| API配置 | `app/src/main/java/com/example/aichat_10/service/ApiClient.kt` |
| 数据模型 | `app/src/main/java/com/example/aichat_10/data/` |
| UI组件 | `app/src/main/java/com/example/aichat_10/ui/components/` |

### B. 参考文档

- [Jetpack Compose官方文档](https://developer.android.com/jetpack/compose)
- [Retrofit官方文档](https://square.github.io/retrofit/)
- [Kotlin Coroutines指南](https://kotlinlang.org/docs/coroutines-guide.html)
- [OpenAI API文档](https://platform.openai.com/docs/api-reference)

---

**报告生成时间**: 2025年 11月 28日
**项目版本**: 1.0  
**文档版本**: 1.0
