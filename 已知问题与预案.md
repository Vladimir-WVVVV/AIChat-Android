# 已知问题与预案（2025-11-28）

## 问题摘要
- 构建失败：`R.jar` 文件锁导致 `:app:processDebugResources FAILED`（路径：`app/build/intermediates/compile_and_runtime_not_namespaced_r_class_jar/.../R.jar`）。
- 后端端口占用：Spring Boot 重启时报 `8080` 端口被占用。
- 真机无法访问后端：未进行 `adb reverse` 时，App 访问 `127.0.0.1:8080` 不通。

## 现象与日志
- Build Output 报错：`Execution failed for task ':app:processDebugResources'` → 指向 `R.jar` 无法删除。
- 端口占用：后端启动失败，提示 `Address already in use: bind`。

## 根因分析
- Windows 平台文件锁：IDE 预览（Desktop Preview）、常驻工具窗口（App Inspection、Layout Validation、Profiler、Logcat 等）或索引器占用中间产物目录。
- 构建并发竞争：Gradle 多 worker/KAPT worker 导致资源竞争加剧。
- 设备网络路径：真机上的 `127.0.0.1` 指向手机自身，需通过 `adb reverse` 将手机端口映射到开发机。

## 预备解决办法
- 关闭占用句柄的窗口：
  - `View -> Tool Windows -> Desktop Preview` 关闭；同时关闭 `App Inspection`、`Layout Validation`、`Profiler`、`Running Devices`、`Logcat` 等。
- 目录排除与安全软件例外：
  - 在 IDE 中将 `app/build` 标记为 `Excluded`，避免索引占用。
  - 将 `E:\AIChat10\app\build\intermediates` 加入杀毒/Defender 排除列表。
- 构建稳定性配置（已落实）：
  - 单 worker：`gradle.properties:10` → `org.gradle.workers.max=1`。
  - 禁用 KAPT worker API：`gradle.properties:25` → `kapt.use.worker.api=false`。
  - 预清理中间目录：`app/build.gradle.kts:80-84` 在 `processDebugResources` 前删除 `compile_and_runtime_not_namespaced_r_class_jar`。
  - 组合任务：`app/build.gradle.kts:86-88` 注册 `cleanBuildDebug`（`clean`+`assembleDebug`）。
- 守护进程控制：
  - 构建前执行 `./gradlew --stop` 停止守护进程，降低句柄残留概率。
- 真机一键连通：
  - 在 Run Configuration 的 “Before launch” 添加外部工具 `adb reverse tcp:8080 tcp:8080`，保证 App 的 `http://127.0.0.1:8080` 可达。
- 后端端口释放：
  - 在后端 IDE 启动前执行 PowerShell 命令清理占用进程（已配置到 Eclipse 启动组）。

## 验证步骤
- 命令行构建：在终端运行 `./gradlew :app:cleanBuildDebug -x lint` 验证是否成功（若成功而 IDE 失败，则基本确定为 IDE/插件持锁）。
- IDE 构建：关闭预览/常驻窗口、排除 `build` 后，在 Android Studio 点击 Run 观察是否消除 `R.jar` 报错。
- 联通性：真机安装后，在 App 中发送消息，确认能通过 `SSE` 接收增量响应（后端需已启动，端口 8080 可用）。

## 风险与回滚
- 若关闭预览影响开发体验，可在问题修复后再逐步开启；构建失败再次出现时重新关闭。
- 若 `adb reverse` 与某些设备冲突，可改为 Wi-Fi 同网下直连开发机 IP，并将 `serverBase` 改为 `http://<PC-IP>:8080`。

## 关键文件定位
- 后端基地址：`app/src/main/java/com/example/aichat_10/viewmodel/ChatViewModel.kt:32`
- SSE 增量拼接：`app/src/main/java/com/example/aichat_10/viewmodel/ChatViewModel.kt:90-117`
- 规则引擎兜底：`app/src/main/java/com/example/aichat_10/service/ChatRuleEngine.kt:42-55`
- 预清理与组合任务：`app/build.gradle.kts:80-84`、`app/build.gradle.kts:86-88`
- 并发与 KAPT 配置：`gradle.properties:10`、`gradle.properties:25`

